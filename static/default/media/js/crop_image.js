/*
	This js require thickbox.js,thickbox.css,jquery.Jcrop.css,jquery.Jcrop.min.js and crop_image.js.
	Must include "cropping_img_template.html" from shared folder in Form.
	img_crop_dict is a global dictionary whcih has a id_photo, id_signature, id_thumb as a sub dictionary. In each subdictionary,
	their is 8 keys which are (x,y,x1,y1,h,w,resize_x,resize_y). These (x,y,x1,y1,h,w) keys are generated by jcrop for cropped image
	and (resize_x,resize_y) keys are the width and height of upoaded image.
*/

var img_crop_dict = {};
var img_temp_dict = {};
var current_img_type;
var original_tb_remove = tb_remove;
var api;
$(function(){
    $('input[type="file"]').each(function(index, input_element){
        $(input_element).change(function(){
            preview(input_element.id, 3.5, 3.5);
        });
    });
//	$('#id_upload_photo').change(function(){
//		preview("id_upload_photo",3.5,4.5);
//	});
//	$('#id_upload_signature').change(function(){
//		preview("id_upload_signature",4,3);
//	});
//	$('#id_upload_thumb').change(function(){
//		preview("id_upload_thumb",4,3);
//	});
});
tb_remove = function (){
    original_tb_remove();
    api.destroy();
    $("#TB_window").empty().remove();
    return false;
}
function showSnap(coords)
{
    var rx = 138 / coords.w;
    var ry = 138 / coords.h;
    img_height = $('#preview_image').height();
    img_width = $('#preview_image').width();
    $('#snap').css({
        width: Math.round(rx * img_width) + 'px',
        height: Math.round(ry * img_height) + 'px',
        marginLeft: '-' + Math.round(rx * coords.x) + 'px',
        marginTop: '-' + Math.round(ry * coords.y) + 'px',
        display:'block'
    });
}
function write_to_cropdict(){
    img_temp_dict[current_img_type].resize_x = $('#preview_image').width();
    img_temp_dict[current_img_type].resize_y = $('#preview_image').height();        
    img_crop_dict[current_img_type] = img_temp_dict[current_img_type];
    $("#id_cropdict").val(JSON.stringify(img_crop_dict));
}
function showCoords(c)
{
    dict2 = {'x':c.x, 'y':c.y, 'x2':c.x2, 'y2':c.y2, 'w':c.w, 'h':c.h};
    img_temp_dict[current_img_type] = dict2;
    showSnap(c);
}
function preview(input, ratio_l, ratio_r) {
	input_element = document.getElementById(input);
//    html = '<img id="preview_image" style="max-height:328px; max-width:711px; top: 12px; left: 20px; display:none;position: absolute;" onmouseover="return click_function(this' + ',' + ratio_l + ',' + ratio_r +')">\
//            </br>\
//            <div style="width:100px;height:100px;overflow:hidden;margin-left:5px;">\
//            <img src="" id="snap" style="max-width: none;"/>\
//            </div>\
//            <input type="button" value="Done" onclick="write_to_cropdict();return tb_remove();">&nbsp\
//            <input type="button" value="Cancel" onclick="return tb_remove()">';
    html = '<div class="div_cointainer_photo"><div class="close"><a href="" onclick="tb_remove();return false;"></a></div>\
        <div class="picbig"><strong>Select the area of the image you want to upload</strong>\
        <img src="" id="preview_image" style="max-height:328px; max-width:392px; top: 12px; left: 20px; display:block;position: absolute;" onmouseover="return click_function(this' + ',' + ratio_l + ',' + ratio_r +')">\
        </div>\
            <div class="preview">\
                <strong>Preview</strong>\
                <div style="width:138px;height:138px;overflow:hidden;margin-left:5px;margin-bottom:10px;">\
                <img src="" id="snap" style="max-width: none;">\
                </div>\
                <button type="submit" class="btn buttongreen" onclick="write_to_cropdict();save_cropped_image(input_element);">Done cropping</button>\
                </div>\
                <div class="clear"></div></div>'
    $('#' + 'a_tag').click();
    $("#TB_window").css({'background':'none','border':'none'});

    $("#TB_ajaxContent").empty().html(html);
    if($('#TB_window').children('#TB_title').length > 0){$('#TB_window').children('#TB_title').remove();}
    if (input_element.files && input_element.files[0])
    {
        current_img_type = $(input_element).attr('id');
        var reader1 = new FileReader();
        var reader2 = new FileReader();
        reader1.onload = function (e) {
//            $('#'+'preview_image').fadeOut('slow');
            $('#'+'preview_image').show();
            $('#'+'preview_image').attr('src', e.target.result);
        };
        reader1.readAsDataURL(input_element.files[0]);
        reader2.onload = function (e) {
//            $('#'+'snap').fadeOut('slow');
            $('#'+'snap').show();
            $('#snap') .attr('src', e.target.result);


        };
        reader2.readAsDataURL(input_element.files[0]);
    }
}
function click_function(input, ratio_l, ratio_r){
    opt={};
    opt.allowResize = true;
    opt.allowSelect = true;
    opt.setSelect = [0,0,200,200];
    opt.onSelect = showCoords;
    opt.onChange = showCoords;
    opt.aspectRatio = ratio_l / ratio_r;
    api = $.Jcrop(input, opt);
}
